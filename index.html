<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAC Jazba - Control de Inventario</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Module Loader -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc, query, orderBy, limit, writeBatch, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
            getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc, query, orderBy, limit, writeBatch, serverTimestamp, where
        };

        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .table-container { max-height: 350px; overflow-y: auto; }
        thead th { position: sticky; top: 0; background: #f9fafb; z-index: 10; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: #666; flex-direction: column;">
            <div style="text-align: center;">
                <div class="animate-spin h-8 w-8 border-4 border-blue-600 rounded-full border-t-transparent mx-auto mb-4"></div>
                <p>Iniciando sistema Jazba...</p>
            </div>
            <!-- Mensaje de error amigable si falta configuración -->
            <div id="config-warning" style="display:none; margin-top: 20px; padding: 20px; background: #fee2e2; color: #b91c1c; border-radius: 8px; max-width: 400px; text-align: center; border: 1px solid #f87171;">
                <strong>⚠️ Falta configuración de Base de Datos</strong><br><br>
                Para usar este sistema en GitHub/Internet:<br>
                1. Abre este archivo HTML en un editor de texto.<br>
                2. Busca la línea 80.<br>
                3. Reemplaza los datos de ejemplo con los de tu proyecto Firebase.
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Hashing para Password ---
        async function hashPassword(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Bootstrap ---
        const bootstrap = async () => {
            if (!window.firebase) await new Promise(resolve => window.addEventListener('firebase-ready', resolve));
            const { initializeApp, getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, writeBatch, serverTimestamp, query, orderBy, limit, where } = window.firebase;

            // ==========================================================================================
            // --- ZONA DE EDICIÓN: PEGA TUS CREDENCIALES AQUÍ ---
            // Si estás viendo esto en GitHub y te sale error, reemplaza los valores de abajo 
            // con los que te da Firebase Console -> Configuración del Proyecto -> General -> Tus apps
            // ==========================================================================================
            
            let firebaseConfig = {
  apiKey: "AIzaSyAoQV-Td9bA2cDGo2cNYGYhfrZdlF9U8wE",
  authDomain: "control-inventario-dac-jazba.firebaseapp.com",
  projectId: "control-inventario-dac-jazba",
  storageBucket: "control-inventario-dac-jazba.firebasestorage.app",
  messagingSenderId: "81783414754",
  appId: "1:81783414754:web:2bb8e712f867375c8863bb"
};

            // Detectar entorno de prueba (No borrar esto, es para que funcione en el chat)
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config); 
            }
            
            // Validación para avisarte si olvidaste poner las claves
            if (firebaseConfig.apiKey === "PEGAR_TU_API_KEY_AQUI" && typeof __firebase_config === 'undefined') {
                document.querySelector('.animate-spin').style.display = 'none';
                document.getElementById('config-warning').style.display = 'block';
                return; // Detiene la app para evitar errores de consola
            }
            // ==========================================================================================

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // Usamos un ID fijo o dinámico según el entorno
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'jazba-inventory-prod';

            // --- Componente Icono INTEGRADO (Sin librerías externas para máxima velocidad) ---
            const Icon = ({ name, size = 20, className = "" }) => {
                const svgs = {
                    'box': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
                    'scan-barcode': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 7v10"/><path d="M12 7v10"/><path d="M17 7v10"/></svg>,
                    'lock': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
                    'arrow-left': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
                    'trash-2': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                    'check': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>,
                    'undo-2': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>,
                    'file-down': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>,
                    'alert-triangle': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
                    'barcode': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 5v14"/><path d="M8 5v14"/><path d="M12 5v14"/><path d="M17 5v14"/><path d="M21 5v14"/></svg>
                };
                return svgs[name] || null;
            };

            const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, type = "button" }) => {
                const variants = {
                    primary: "bg-blue-600 text-white hover:bg-blue-700 disabled:bg-blue-300",
                    secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300 disabled:bg-gray-100",
                    danger: "bg-red-500 text-white hover:bg-red-600 disabled:bg-red-300",
                    success: "bg-green-600 text-white hover:bg-green-700 disabled:bg-green-300",
                    outline: "border-2 border-blue-600 text-blue-600 hover:bg-blue-50"
                };
                return <button type={type} onClick={onClick} className={`px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors ${variants[variant]} ${className}`} disabled={disabled}>{children}</button>;
            };

            const Card = ({ children, title, className = "" }) => (
                <div className={`bg-white rounded-xl shadow-md p-6 ${className} fade-in`}>
                    {title && <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">{title}</h2>}
                    {children}
                </div>
            );

            // --- LOGIN ---
            const LoginScreen = ({ onLoginAdmin, onStartScan }) => {
                const [mode, setMode] = useState('menu'); 
                const [pass, setPass] = useState('');
                const [loading, setLoading] = useState(false);
                const [resetConfirm, setResetConfirm] = useState(false);

                const checkPass = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    try {
                        const hash = await hashPassword(pass);
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'system_settings', 'security');
                        const snap = await getDoc(docRef);
                        
                        if (!snap.exists()) {
                            await setDoc(docRef, { admin_hash: hash });
                            alert("Contraseña creada exitosamente.");
                            onLoginAdmin();
                        } else if (snap.data().admin_hash === hash) {
                            onLoginAdmin();
                        } else {
                            alert("Contraseña incorrecta.");
                        }
                    } catch (err) { alert(err.message); }
                    setLoading(false);
                };

                const handleReset = async () => {
                    if (!resetConfirm) {
                        setResetConfirm(true);
                        setTimeout(() => setResetConfirm(false), 3000);
                        return;
                    }
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'system_settings', 'security'));
                        alert("Sistema restablecido. Ingresa una nueva contraseña.");
                        setResetConfirm(false);
                        setPass('');
                    } catch (e) { alert("Error: " + e.message); }
                };

                if (mode === 'menu') return (
                    <div className="flex flex-col items-center justify-center pt-10 gap-6">
                        <h1 className="text-3xl font-bold text-slate-800">DAC Jazba Control</h1>
                        <button onClick={onStartScan} className="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg border-2 border-blue-600 flex flex-col items-center hover:bg-blue-50 transition-all">
                            <div className="bg-blue-100 p-4 rounded-full mb-4"><Icon name="scan-barcode" size={48} className="text-blue-600"/></div>
                            <span className="text-xl font-bold text-blue-900">Soy Asesor</span>
                            <span className="text-blue-600">Iniciar Inventario</span>
                        </button>
                        <button onClick={() => setMode('admin')} className="text-gray-500 hover:text-gray-800 flex items-center gap-2"><Icon name="lock" size={16}/> Acceso Admin</button>
                    </div>
                );

                return (
                    <div className="flex justify-center pt-10">
                        <Card className="w-full max-w-md">
                            <button onClick={() => setMode('menu')} className="mb-4 text-gray-400"><Icon name="arrow-left"/></button>
                            <h2 className="text-xl font-bold mb-4 text-center">Acceso Admin</h2>
                            <form onSubmit={checkPass} className="space-y-4">
                                <input type="password" required autoFocus className="w-full p-2 border rounded" placeholder="Contraseña..." value={pass} onChange={e=>setPass(e.target.value)}/>
                                <Button type="submit" className="w-full" disabled={loading}>{loading ? '...' : 'Ingresar'}</Button>
                            </form>
                            <div className="mt-6 pt-6 border-t text-center">
                                <button onClick={handleReset} className={`text-xs ${resetConfirm ? 'text-white bg-red-500 p-2 rounded font-bold' : 'text-red-400 hover:underline'}`}>
                                    {resetConfirm ? "¿CONFIRMAR RESTABLECER?" : "Olvidé Contraseña / Restablecer"}
                                </button>
                            </div>
                        </Card>
                    </div>
                );
            };

            // --- ADMIN DASHBOARD ---
            const Dashboard = ({ advisors, stores, masterInventory, logout, refreshData }) => {
                const [tab, setTab] = useState('inventory');
                const [file, setFile] = useState(null);
                const [uploadStore, setUploadStore] = useState('');
                const [uploading, setUploading] = useState(false);
                const [history, setHistory] = useState([]);
                const [lastUpload, setLastUpload] = useState(null);
                
                const [confirmUndo, setConfirmUndo] = useState(false);
                const [confirmDeleteId, setConfirmDeleteId] = useState(null); 
                const [deletingId, setDeletingId] = useState(null); 
                const [deleteAllConfirm, setDeleteAllConfirm] = useState(false); 

                const tabNames = { inventory: 'Inventario', history: 'Historial', advisors: 'Asesores', stores: 'Tiendas', settings: 'Configuración' };

                useEffect(() => { 
                    if (tab === 'history') loadHistory(); 
                    if (tab === 'inventory') loadLastUploadInfo();
                }, [tab]);

                const loadHistory = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'audit_records'), orderBy('timestamp', 'desc'), limit(28));
                    const snap = await getDocs(q);
                    setHistory(snap.docs.map(d => ({id:d.id, ...d.data()})));
                };

                const loadLastUploadInfo = async () => {
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'upload_logs'), orderBy('timestamp', 'desc'), limit(1));
                    const snap = await getDocs(q);
                    if (!snap.empty) setLastUpload({ id: snap.docs[0].id, ...snap.docs[0].data() });
                    else setLastUpload(null);
                };

                const handleUpload = async () => {
                    if (!file || !uploadStore) return alert("Selecciona archivo y tienda");
                    setUploading(true);
                    try {
                        const rows = await readXlsxFile(file);
                        const batch = writeBatch(db);
                        const batchId = Date.now().toString(); 
                        let count = 0;
                        
                        for (let i = 1; i < rows.length; i++) {
                            if (rows[i][0]) {
                                const imei = String(rows[i][0]).trim();
                                const model = rows[i][1] ? String(rows[i][1]).trim() : "Desconocido";
                                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_master', imei);
                                batch.set(ref, { 
                                    imei, model, store: uploadStore, status: 'active', 
                                    addedAt: serverTimestamp(),
                                    batchId: batchId 
                                });
                                count++;
                            }
                        }

                        const logRef = doc(db, 'artifacts', appId, 'public', 'data', 'upload_logs', batchId);
                        batch.set(logRef, {
                            timestamp: serverTimestamp(),
                            count: count,
                            storeName: uploadStore,
                            fileName: file.name
                        });

                        await batch.commit();
                        alert(`Cargados ${count} equipos a ${uploadStore}`);
                        setFile(null);
                        refreshData();
                        loadLastUploadInfo();
                    } catch (e) { alert("Error: " + e.message); }
                    setUploading(false);
                };

                const handleUndoLastUpload = async () => {
                    if (!lastUpload) return;
                    if (!confirmUndo) {
                        setConfirmUndo(true);
                        setTimeout(() => setConfirmUndo(false), 3000);
                        return;
                    }
                    setUploading(true);
                    try {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_master'), where("batchId", "==", lastUpload.id));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'upload_logs', lastUpload.id));
                        await batch.commit();
                        alert(`Eliminados ${snapshot.size} registros.`);
                        setConfirmUndo(false);
                        refreshData();
                        loadLastUploadInfo();
                    } catch (e) { alert("Error al deshacer: " + e.message); }
                    setUploading(false);
                };

                const handleDeleteHistory = async (id) => {
                    if (confirmDeleteId !== id) {
                        setConfirmDeleteId(id);
                        setTimeout(() => setConfirmDeleteId(null), 3000);
                        return;
                    }
                    setHistory(prev => prev.filter(h => h.id !== id));
                    setConfirmDeleteId(null);
                    try {
                        const recordRef = doc(db, 'artifacts', appId, 'public', 'data', 'audit_records', id);
                        const recordSnap = await getDoc(recordRef);
                        if (!recordSnap.exists()) return;
                        const recordData = recordSnap.data();
                        const batch = writeBatch(db);
                        if (recordData.missingItems && recordData.missingItems.length > 0) {
                            recordData.missingItems.forEach(item => {
                                if (['vendido', 'traslado'].includes(item.status)) {
                                    const invRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_master', item.imei);
                                    batch.set(invRef, { imei: item.imei, model: item.model, store: recordData.storeName, status: 'active', restoredAt: serverTimestamp() });
                                }
                            });
                        }
                        batch.delete(recordRef);
                        await batch.commit();
                        refreshData();
                    } catch(e) { alert("Error: " + e.message); loadHistory(); }
                };

                const handleDeleteAllData = async () => {
                    if (!deleteAllConfirm) {
                        setDeleteAllConfirm(true);
                        setTimeout(() => setDeleteAllConfirm(false), 4000);
                        return;
                    }

                    setUploading(true);
                    try {
                        const collections = ['inventory_master', 'audit_records', 'upload_logs'];
                        
                        for (const collName of collections) {
                            const q = query(collection(db, 'artifacts', appId, 'public', 'data', collName));
                            const snapshot = await getDocs(q);
                            
                            const batchSize = 400;
                            let batch = writeBatch(db);
                            let count = 0;

                            for (const doc of snapshot.docs) {
                                batch.delete(doc.ref);
                                count++;
                                if (count >= batchSize) {
                                    await batch.commit();
                                    batch = writeBatch(db);
                                    count = 0;
                                }
                            }
                            if (count > 0) await batch.commit();
                        }
                        
                        alert("Sistema restablecido correctamente.");
                        refreshData();
                        loadLastUploadInfo();
                        loadHistory();
                        setDeleteAllConfirm(false);
                    } catch (e) {
                        alert("Error al borrar: " + e.message);
                    }
                    setUploading(false);
                };

                const addItem = async (coll, field, val) => {
                    if(val) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', coll), { name: val }); refreshData(); }
                };

                const handleDeleteGeneric = async (coll, id) => {
                    if (deletingId !== id) {
                        setDeletingId(id);
                        setTimeout(() => setDeletingId(null), 3000);
                        return;
                    }
                    
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
                        setDeletingId(null);
                        refreshData();
                    } catch (e) { alert(e.message); }
                };

                const generatePDF = (record) => {
                    const doc = new jspdf.jsPDF();
                    doc.setFontSize(16);
                    doc.text("Reporte Histórico - DAC Jazba", 14, 20);
                    doc.setFontSize(10);
                    doc.text(`Fecha: ${new Date(record.date).toLocaleString()}`, 14, 30);
                    doc.text(`Tienda: ${record.storeName} | Asesor: ${record.advisorName}`, 14, 35);
                    doc.setFillColor(240, 240, 240);
                    doc.rect(14, 40, 180, 15, 'F');
                    doc.text(`Escaneados: ${record.scannedCount} | Faltantes: ${record.missingItems?.length||0} | Traslados: ${record.transfersIn?.length||0}`, 20, 49);

                    let currentY = 65;
                    if (record.scannedItemsList && record.scannedItemsList.length > 0) {
                        doc.setFontSize(12); doc.setTextColor(0, 100, 0); doc.text("1. Equipos Escaneados", 14, 60); doc.setTextColor(0, 0, 0);
                        doc.autoTable({
                            startY: 65,
                            head: [['IMEI', 'Modelo', 'Estado']],
                            body: record.scannedItemsList.map(s => [s.imei, s.model, s.status === 'TRANSFER' ? 'TRASLADO (ENT)' : s.status]),
                            theme: 'striped',
                            headStyles: { fillColor: [46, 204, 113] }
                        });
                        currentY = doc.lastAutoTable.finalY + 15;
                    }

                    if (record.missingItems && record.missingItems.length > 0) {
                        doc.setFontSize(12); doc.setTextColor(200, 0, 0); doc.text("2. Equipos Faltantes", 14, currentY); doc.setTextColor(0, 0, 0);
                        const missingRows = [];
                        record.missingItems.forEach(i => missingRows.push([i.imei, i.model, i.status, i.description||'-']));
                        doc.autoTable({ 
                            startY: currentY + 5, 
                            head: [['IMEI', 'Modelo', 'Motivo', 'Detalle']], 
                            body: missingRows,
                            theme: 'striped',
                            headStyles: { fillColor: [231, 76, 60] }
                        });
                    }
                    doc.save(`reporte_historico_${record.date}.pdf`);
                };

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                            <h2 className="text-lg font-bold">Panel Admin</h2>
                            <Button variant="outline" onClick={logout}><Icon name="log-out" size={16}/> Salir</Button>
                        </div>
                        <div className="bg-white rounded-lg shadow p-4">
                            <div className="flex border-b mb-4 overflow-x-auto">
                                {Object.keys(tabNames).map(k => (
                                    <button key={k} onClick={()=>setTab(k)} className={`px-4 py-2 ${tab===k?'border-b-2 border-blue-600 text-blue-600':'text-gray-500'}`}>{tabNames[k]}</button>
                                ))}
                            </div>

                            {tab === 'inventory' && (
                                <div>
                                    {stores.length === 0 ? (
                                        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg mb-4 flex items-center gap-2">
                                            <Icon name="alert-triangle" size={24} />
                                            <div><p className="font-bold">¡Atención!</p><p className="text-sm">Crea una tienda primero.</p></div>
                                        </div>
                                    ) : (
                                        <div className="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                                            <h3 className="font-bold mb-2">Cargar Inventario</h3>
                                            <div className="flex flex-col md:flex-row gap-2">
                                                <select className="p-2 border rounded" value={uploadStore} onChange={e=>setUploadStore(e.target.value)}>
                                                    <option value="">Seleccionar Tienda...</option>
                                                    {stores.map(s=> <option key={s.id} value={s.name}>{s.name}</option>)}
                                                </select>
                                                <input type="file" onChange={e=>setFile(e.target.files[0])} className="p-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-white file:text-blue-700 hover:file:bg-blue-50"/>
                                                <Button onClick={handleUpload} disabled={uploading}>Subir</Button>
                                            </div>
                                            {lastUpload && (
                                                <div className="mt-4 pt-4 border-t border-blue-200 flex justify-between items-center text-sm">
                                                    <span className="text-blue-800">
                                                        Última carga: <strong>{lastUpload.fileName}</strong> ({lastUpload.count} items) en {lastUpload.storeName}
                                                    </span>
                                                    <button 
                                                        onClick={handleUndoLastUpload} 
                                                        disabled={uploading} 
                                                        className={`font-bold flex items-center gap-1 transition-colors px-3 py-1 rounded ${confirmUndo ? 'bg-red-600 text-white' : 'text-red-500 hover:text-red-700 underline'}`}
                                                    >
                                                        <Icon name="undo-2" size={14}/> {confirmUndo ? "¿CONFIRMAR?" : "Deshacer Carga"}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <div className="overflow-x-auto table-container">
                                        <table className="min-w-full text-sm text-left">
                                            <thead className="bg-gray-100 text-xs uppercase"><tr><th className="px-4 py-2">Tienda</th><th className="px-4 py-2">Modelo</th><th className="px-4 py-2">IMEI</th></tr></thead>
                                            <tbody>
                                                {masterInventory.map(i => (
                                                    <tr key={i.imei} className="border-b"><td className="px-4 py-2 font-bold text-gray-600">{i.store || '-'}</td><td className="px-4 py-2">{i.model}</td><td className="px-4 py-2 font-mono">{i.imei}</td></tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {tab === 'history' && (
                                <div className="space-y-2">
                                    {history.map(h => (
                                        <div key={h.id} className="border p-3 rounded flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-sm">{new Date(h.date).toLocaleString()}</div>
                                                <div className="text-xs text-gray-500">{h.storeName} - {h.advisorName}</div>
                                                <div className="text-xs mt-1">
                                                    <span className="text-green-600">Escaneados: {h.scannedCount}</span> | <span className="text-red-500">Faltantes: {h.missingItems?.length||0}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <Button variant="outline" onClick={()=>generatePDF(h)}><Icon name="file-down" size={14}/></Button>
                                                <button 
                                                    onClick={()=>handleDeleteHistory(h.id)} 
                                                    className={`p-2 rounded flex items-center transition-colors ${confirmDeleteId === h.id ? 'bg-red-600 text-white' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}
                                                >
                                                    <Icon name={confirmDeleteId === h.id ? "check" : "trash-2"} size={16}/>
                                                    {confirmDeleteId === h.id && <span className="ml-1 text-xs">¿?</span>}
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {tab === 'settings' && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                                    <h3 className="text-xl font-bold text-red-700 mb-4">Zona de Peligro</h3>
                                    <p className="text-red-600 mb-6">Estas acciones son destructivas y no se pueden deshacer.</p>
                                    
                                    <button 
                                        onClick={handleDeleteAllData}
                                        disabled={uploading}
                                        className={`font-bold py-3 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 mx-auto transition-colors disabled:opacity-50 ${deleteAllConfirm ? 'bg-red-800 text-white animate-pulse' : 'bg-red-600 hover:bg-red-700 text-white'}`}
                                    >
                                        <Icon name="trash-2" size={20} /> 
                                        {uploading ? 'Borrando...' : (deleteAllConfirm ? '¿ESTÁS SEGURO? CONFIRMAR' : 'Borrar Todo (Equipos e Historial)')}
                                    </button>
                                </div>
                            )}

                            {(tab === 'advisors' || tab === 'stores') && (
                                <div>
                                    <form onSubmit={(e)=>{e.preventDefault(); addItem(tab, 'name', e.target.val.value); e.target.reset();}} className="flex gap-2 mb-4">
                                        <input name="val" placeholder={`Nuevo...`} className="border p-2 rounded flex-1"/>
                                        <Button type="submit">Agregar</Button>
                                    </form>
                                    <div className="grid grid-cols-2 gap-2">
                                        {(tab==='advisors'?advisors:stores).map(i=>(
                                            <div key={i.id} className="p-2 border rounded flex justify-between bg-gray-50 items-center">
                                                <span>{i.name}</span>
                                                <button 
                                                    onClick={()=>handleDeleteGeneric(tab, i.id)} 
                                                    className={`p-2 rounded transition-colors ${deletingId === i.id ? 'bg-red-600 text-white' : 'text-red-500 hover:bg-red-100'}`}
                                                >
                                                    {deletingId === i.id ? '¿?' : <Icon name="trash-2" size={14}/>}
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // --- SCANNER ---
            const Scanner = ({ advisors, stores, masterInventory, onBack, refreshData }) => {
                const [step, setStep] = useState(1);
                const [selAdv, setSelAdv] = useState('');
                const [selStore, setSelStore] = useState('');
                
                const scannedRef = useRef(new Set());
                const [scannedCount, setScannedCount] = useState(0); 
                const [scanLog, setScanLog] = useState([]); 
                const [transfersIn, setTransfersIn] = useState([]); 
                
                const [input, setInput] = useState('');
                const inputRef = useRef(null);
                
                const [missing, setMissing] = useState([]);
                const blockedCodesRef = useRef(new Set());

                const handleScan = (code) => {
                    const imei = code.trim();
                    if(!imei) return;
                    
                    setScannedCount(prev => {
                        if (scannedRef.current.has(imei) || blockedCodesRef.current.has(imei)) return prev;
                        
                        const item = masterInventory.find(i => i.imei === imei);
                        let status = 'OK', detail = '', isTransfer = false;

                        if (!item) { status = 'UNKNOWN'; detail = 'No existe en sistema'; }
                        else if (item.store !== selStore) { status = 'TRANSFER'; detail = `Origen: ${item.store}`; isTransfer = true; }

                        const newItem = { imei, model: item ? item.model : 'DESCONOCIDO', status, detail, originStore: item ? item.store : null };

                        setScanLog(prevLog => [newItem, ...prevLog]);
                        if (isTransfer) setTransfersIn(prevTrans => [...prevTrans, newItem]);
                        
                        scannedRef.current.add(imei);
                        return scannedRef.current.size;
                    });
                };

                const removeScan = (imeiToDelete) => {
                    scannedRef.current.delete(imeiToDelete);
                    setScannedCount(scannedRef.current.size);
                    
                    blockedCodesRef.current.add(imeiToDelete);
                    setTimeout(() => { blockedCodesRef.current.delete(imeiToDelete); }, 3000); 

                    setScanLog(prev => prev.filter(item => item.imei !== imeiToDelete));
                    setTransfersIn(prev => prev.filter(item => item.imei !== imeiToDelete));
                    if(inputRef.current) inputRef.current.focus();
                };

                const finish = () => {
                    const missingList = masterInventory.filter(i => i.store === selStore && !scannedRef.current.has(i.imei));
                    setMissing(missingList.map(i => ({...i, status: 'missing', reason: '', desc: ''})));
                    setStep(3);
                };

                const saveAndExport = async () => {
                    try {
                        const batch = writeBatch(db);
                        const dateIso = new Date().toISOString();
                        const scannedItemsList = scanLog.map(s => ({ imei: s.imei, model: s.model, status: s.status, originStore: s.originStore || null }));

                        const auditRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'audit_records'));
                        batch.set(auditRef, {
                            date: dateIso, timestamp: serverTimestamp(), advisorName: selAdv, storeName: selStore, scannedCount: scannedRef.current.size,
                            scannedItemsList, missingItems: missing.map(m => ({ imei: m.imei, model: m.model, status: m.status, description: m.desc })),
                            transfersIn: transfersIn.map(t => ({ imei: t.imei, model: t.model, originStore: t.originStore }))
                        });

                        transfersIn.forEach(t => batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_master', t.imei), { store: selStore }));
                        missing.forEach(m => { if (['vendido', 'traslado'].includes(m.status)) batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_master', m.imei)); });

                        await batch.commit();
                        
                        const pdf = new jspdf.jsPDF();
                        pdf.setFontSize(18); pdf.text("Reporte Final - Inventario DAC Jazba", 14, 20);
                        pdf.setFontSize(10); pdf.text(`Tienda: ${selStore} | Asesor: ${selAdv} | Fecha: ${new Date().toLocaleString()}`, 14, 30);
                        pdf.setFillColor(240, 240, 240); pdf.rect(14, 35, 180, 15, 'F');
                        pdf.text(`Encontrados: ${scannedRef.current.size} | Faltantes: ${missing.length}`, 20, 44);

                        pdf.autoTable({ startY: 55, head: [['IMEI', 'Modelo', 'Estado']], body: scanLog.map(s => [s.imei, s.model, s.status === 'TRANSFER' ? 'TRASLADO (ENTRADA)' : s.status]) });
                        
                        if(missing.length > 0) {
                            pdf.text("Faltantes / Novedades", 14, pdf.lastAutoTable.finalY + 10);
                            pdf.autoTable({ startY: pdf.lastAutoTable.finalY + 15, head: [['IMEI', 'Modelo', 'Motivo', 'Detalle']], body: missing.map(m => [m.imei, m.model, m.status, m.desc || '-']) });
                        }
                        
                        pdf.save(`Inventario_${selStore}_${dateIso}.pdf`);
                        alert("Guardado y PDF generado.");
                        refreshData();
                        onBack();
                    } catch (e) { alert("Error: " + e.message); }
                };

                if (step === 1) return (
                    <Card title="Configuración Inicial" className="max-w-md mx-auto mt-10">
                        <div className="space-y-4">
                            <div><label className="block text-sm font-bold text-gray-700">Tienda</label><select className="w-full p-2 border rounded mt-1" value={selStore} onChange={e=>setSelStore(e.target.value)}><option value="">Seleccione...</option>{stores.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select></div>
                            <div><label className="block text-sm font-bold text-gray-700">Asesor</label><select className="w-full p-2 border rounded mt-1" value={selAdv} onChange={e=>setSelAdv(e.target.value)}><option value="">Seleccione...</option>{advisors.map(a=><option key={a.id} value={a.name}>{a.name}</option>)}</select></div>
                            <div className="flex gap-2 mt-4"><Button variant="secondary" onClick={onBack} className="flex-1">Cancelar</Button><Button onClick={()=>setStep(2)} disabled={!selStore || !selAdv} className="flex-1">Iniciar</Button></div>
                        </div>
                    </Card>
                );

                if (step === 2) return (
                    <div className="max-w-2xl mx-auto space-y-4">
                        <div className="bg-white p-4 rounded shadow flex justify-between items-center">
                            <div><h2 className="font-bold text-lg">{selStore}</h2><p className="text-xs text-gray-500">{selAdv}</p></div>
                            <div className="text-right"><div className="text-2xl font-bold text-blue-600">{scannedCount}</div><div className="text-xs text-gray-400">Escaneados</div></div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={onBack} className="bg-gray-200 px-4 rounded"> Atrás </button>
                            <form onSubmit={e=>{e.preventDefault(); handleScan(input); setInput('');}} className="relative flex-1">
                                <input ref={inputRef} autoFocus value={input} onChange={e=>setInput(e.target.value)} className="w-full p-3 pl-10 border-2 border-blue-500 rounded text-lg" placeholder="Escanear IMEI..."/>
                                <div className="absolute left-3 top-4 text-gray-400"><Icon name="barcode"/></div>
                            </form>
                        </div>
                        <div className="bg-white rounded shadow overflow-hidden table-container">
                            <table className="w-full text-sm">
                                <thead className="bg-gray-100 text-xs uppercase"><tr><th className="p-3 text-left">Modelo</th><th className="p-3 text-left">IMEI</th><th className="p-3">Estado</th><th className="p-3"></th></tr></thead>
                                <tbody>
                                    {scanLog.map((l) => (
                                        <tr key={l.imei} className="border-b">
                                            <td className="p-3 font-bold">{l.model}</td>
                                            <td className="p-3 font-mono text-gray-600">{l.imei}</td>
                                            <td className="p-3 text-xs">{l.status==='OK'?<span className="text-green-600 font-bold">OK</span>:<span className="text-red-500">{l.status}</span>}</td>
                                            <td className="p-3 text-right">
                                                <button type="button" onClick={() => removeScan(l.imei)} className="bg-red-500 text-white px-3 py-1 rounded text-xs">Eliminar</button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <Button onClick={finish} className="w-full py-3 text-lg">Finalizar Revisión</Button>
                    </div>
                );

                if (step === 3) return (
                    <div className="max-w-3xl mx-auto pb-20">
                        <Card title="Resultados y Faltantes">
                            {missing.length === 0 ? <div className="text-center py-8 bg-green-50 text-green-700 font-bold">¡Sin faltantes!</div> : (
                                <div className="space-y-4">
                                    <p className="text-sm text-gray-500">Equipos no escaneados en <strong>{selStore}</strong>:</p>
                                    {missing.map((m, i) => (
                                        <div key={m.imei} className="border p-3 rounded flex flex-col md:flex-row gap-2 bg-white shadow-sm">
                                            <div className="flex-1"><div className="font-bold text-red-600">{m.model}</div><div className="font-mono text-xs">{m.imei}</div></div>
                                            <div className="flex-1">
                                                <select className="w-full border p-2 rounded bg-gray-50" value={m.status} onChange={e=>{
                                                    const list = [...missing]; list[i].status = e.target.value; setMissing(list);
                                                }}>
                                                    <option value="missing">Seleccionar Motivo...</option>
                                                    <option value="vendido">Vendido</option>
                                                    <option value="traslado">Traslado</option>
                                                    <option value="otro">Otro</option>
                                                </select>
                                            </div>
                                            <div className="flex-1"><input placeholder="Detalles..." className="w-full border p-2 rounded" value={m.desc} onChange={e=>{const list = [...missing]; list[i].desc = e.target.value; setMissing(list);}}/></div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="flex gap-2 mt-6"><Button variant="secondary" onClick={()=>setStep(2)}>Volver</Button><Button variant="success" onClick={saveAndExport} className="flex-1">Guardar y PDF</Button></div>
                        </Card>
                    </div>
                );
            };

            const App = () => {
                const [authReady, setAuthReady] = useState(false);
                const [user, setUser] = useState(null);
                const [view, setView] = useState('login');
                const [data, setData] = useState({advisors:[], stores:[], inventory:[]});

                useEffect(() => {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                            else await signInAnonymously(auth);
                            setAuthReady(true);
                        } catch (e) { console.error(e); setAuthReady(true); }
                    };
                    const sub = onAuthStateChanged(auth, u => setUser(u));
                    initAuth();
                    return () => sub();
                }, []);

                useEffect(() => { if(authReady && user) refresh(); }, [authReady, user]);

                const refresh = async () => {
                    try {
                        const [adv, sto, inv] = await Promise.all([
                            getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'advisors')),
                            getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'stores')),
                            getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_master'))
                        ]);
                        setData({ advisors: adv.docs.map(d=>({id:d.id, ...d.data()})), stores: sto.docs.map(d=>({id:d.id, ...d.data()})), inventory: inv.docs.map(d=>({id:d.id, ...d.data()})) });
                    } catch(e) { console.error(e); }
                };

                if(!authReady) return <div className="flex h-screen items-center justify-center text-gray-500">Conectando...</div>;

                return (
                    <div className="min-h-screen pb-10 max-w-5xl mx-auto p-4">
                        <nav className="flex justify-between items-center mb-6 border-b pb-4"><div className="flex items-center gap-2 font-bold text-xl text-slate-800"><Icon name="box"/> DAC JAZBA</div></nav>
                        {view === 'login' && <LoginScreen onLoginAdmin={()=>{setView('dashboard');}} onStartScan={()=>setView('scan')} />}
                        {view === 'dashboard' && <Dashboard advisors={data.advisors} stores={data.stores} masterInventory={data.inventory} logout={()=>{setView('login');}} refreshData={refresh}/>}
                        {view === 'scan' && <Scanner advisors={data.advisors} stores={data.stores} masterInventory={data.inventory} onBack={()=>{setView('login'); refresh();}} refreshData={refresh}/>}
                    </div>
                );
            };

            ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        };
        bootstrap();
    </script>
</body>
</html>